# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml
# ADO link: https://msazure.visualstudio.com/One/_apps/hub/ms.vss-build-web.ci-designer-hub?pipelineId=297462&branch=main

trigger:
  none
    
pr: none

pool:
  vmImage: ubuntu-latest

variables:
  VcVersion : 1.10.6
  ROOT: $(Build.SourcesDirectory)
  CDP_DEFINITION_BUILD_COUNT: $[counter('', 0)] # needed for onebranch.pipeline.version task https://aka.ms/obpipelines/versioning
  ENABLE_PRS_DELAYSIGN: 1
  GitVersion.SemVer: ''
  

steps:

- task: PipAuthenticate@1
  inputs:
    artifactFeeds: 'CRC-Dev'
- script: pip install pmc-cli
- task: UseDotNet@2
  continueOnError: false
  inputs:
    packageType: 'sdk'
    version: '6.0.406'
    useGlobalJson: false
    performMultiLevelLookup: true
    workingDirectory: '$(Build.SourcesDirectory)'

- script: chmod -R +x $(Build.SourcesDirectory)
  displayName: 'Allow scripts to be executable on Linux'

  # Ensure the artifact output/bin/obj directories are clean.
# - script: $(Build.SourcesDirectory)/clean.cmd
  # displayName: 'Clean Output Directories'
  
  # Build the repo.
- script: $(Build.SourcesDirectory)/build.sh $(VcVersion)
  displayName: 'Build Solutions'

- script: $(Build.SourcesDirectory)/src/VirtualClient/VirtualClient.Packaging/build-deb-linux-x64.sh $(VcVersion)
  displayName: 'Build deb package for linux x64'

  # Build NuGet packages for the services/agents in the repo.
# - script: $(Build.SourcesDirectory)/build-packages.cmd $(VcVersion)$(VersionSuffix)
  # displayName: 'Build NuGet Packages'

- task: EsrpCodeSigning@1
  inputs:
    ConnectedServiceName: 'virtualclient-esrp'
    FolderPath: '$(Build.SourcesDirectory)/out/packages'
    Pattern: '*.deb'
    signConfigType: 'inlineSignParams'
    inlineOperation: |
      [
          {
              "KeyCode" : "CP-450779-Pgp",
              "OperationCode" : "LinuxSign",
              "Parameters" : {},
              "ToolName" : "sign",
              "ToolVersion" : "1.0"
          }
      ]
    SessionTimeout: '60'
    MaxConcurrency: '50'
    MaxRetryAttempts: '5'


  - task: AzureKeyVault@2
    inputs:
      azureSubscription: 'CRC-AIR-AME-Infra'
      KeyVaultName: 'YOUR_KEYVAULT_NAME'
      SecretsFilter: 'YOUR_SECRETS_FILTER_NAME'
      RunAsPreJob: false
  
  - task: PublishLinuxPackagesPMC@0
    inputs:
      profile: 'prod' # or tux-dev or ppe depending on what you selected
      msal_SNIAuth: 'msal-sniauth'
      msal_cert: $(YOUR_SECRETS_FILTER_NAME) # notice: no single quotation marks
      msal_client_ID: 'YOUR_MSAL_CLIENT_ID'
      package_path: 'YOUR_PACKAGE_PATH'
      repository: 'YOUR_REPO_NAME_OR_ID'