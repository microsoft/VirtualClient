"use strict";(self.webpackChunkvirtualclient=self.webpackChunkvirtualclient||[]).push([[2692],{650:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>s,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>a,toc:()=>d});var r=i(5893),o=i(3905);const t={},l="Profiler Integration",a={id:"developing/0050-develop-profiling-monitor",title:"Profiler Integration",description:"Profilers are applications/programs that are used to capture very detailed information for operations that are happening on the",source:"@site/docs/developing/0050-develop-profiling-monitor.md",sourceDirName:"developing",slug:"/developing/0050-develop-profiling-monitor",permalink:"/VirtualClient/docs/developing/0050-develop-profiling-monitor",draft:!1,unlisted:!1,editUrl:"https://github.com/microsoft/VirtualClient/edit/main/website/docs/developing/0050-develop-profiling-monitor.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"VC Packages",permalink:"/VirtualClient/docs/developing/0040-vc-packages"},next:{title:"Workload Selection Recommendations",permalink:"/VirtualClient/docs/developing/0060-workload-recommendations"}},s={},d=[{value:"Preliminaries",id:"preliminaries",level:2},{value:"Supported Profilers",id:"supported-profilers",level:2},{value:"Profiling Scenarios",id:"profiling-scenarios",level:2},{value:"Interval-Based Profiling",id:"interval-based-profiling",level:2},{value:"Recommendations:",id:"recommendations",level:3},{value:"On-Demand Profiling",id:"on-demand-profiling",level:2},{value:"Recommendations:",id:"recommendations-1",level:3},{value:"Bringing it All Together",id:"bringing-it-all-together",level:2},{value:"Profiling Integration Code Requirements",id:"profiling-integration-code-requirements",level:2},{value:"Add a BackgroundProfiling Block",id:"add-a-backgroundprofiling-block",level:3}];function c(e){const n={a:"a",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.ah)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"profiler-integration",children:"Profiler Integration"}),"\n",(0,r.jsxs)(n.p,{children:["Profilers are applications/programs that are used to capture very detailed information for operations that are happening on the\nsystem. For example, the ",(0,r.jsx)(n.a,{href:"https://eng.ms/docs/products/azure-profiler/azure-profiler",children:"Azure Profiler"})," is a toolet that captures\ndetailed information for various types of low level operations on the system such as CPU callstacks, memory usage, and context\nswitches. The following sections cover support that exists in the Virtual Client for profilers as well as how that is enabled in\nworkload and monitoring profiles."]}),"\n",(0,r.jsx)(n.h2,{id:"preliminaries",children:"Preliminaries"}),"\n",(0,r.jsx)(n.p,{children:"The following pieces of documentation are helpful to understand before implementing any new monitor or profiler support in the\nVirtual Client."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/microsoft/VirtualClient/blob/main/website/docs/overview/features.md",children:"Platform Overview"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/microsoft/VirtualClient/blob/main/website/docs/overview/design.md",children:"Platform Design Aspects"})}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Note that there is a project in the Virtual Client solution that showcases both interval-based as well as on-demand profiling\nscenarios. From Visual Studio, you can set the project ",(0,r.jsx)(n.a,{href:"https://msazure.visualstudio.com/One/_git/CRC-AIR-Workloads?path=/src/VirtualClient/VirtualClient.Examples",children:"VirtualClient.Examples"}),"\nas the startup project and run it. Select option #2 on the initial menu to see an example of interval-based profiling. Select option #3\non the initial menu to see an example of interval-based monitoring. These are just examples so no actual system profiling is happening,\nbut this illustrates the code flow and can be debugged in the Visual Studio IDE."]}),"\n",(0,r.jsx)(n.h2,{id:"supported-profilers",children:"Supported Profilers"}),"\n",(0,r.jsx)(n.p,{children:"The following profilers are currently supported by the Virtual Client:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://eng.ms/docs/products/azure-profiler/azure-profiler",children:"Azure Profiler"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"profiling-scenarios",children:"Profiling Scenarios"}),"\n",(0,r.jsx)(n.p,{children:"The Virtual Client supports a few different profiling scenarios designed to enable flexibility with the capture of information from the\nsystem:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Interval-Based Profiling"}),(0,r.jsx)(n.br,{}),"\n","Interval-based profiling involves running a profiler on consistent intervals constantly throughout the runtime execution of the Virtual\nClient."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"On-Demand Profiling"}),(0,r.jsx)(n.br,{}),"\n","On-demand profiling involves running a profiler only when signaled and for a length of time defined by the component that initiated the\nsignal. For example, a workload executor might want to have profiling run in the background for the duration that the workload itself runs\nand no longer."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"It is recommended that you consider implementing both scenarios in monitors that run profilers. Both scenarios are useful for various needs\nwhen running on Azure guests/VMs vs. Azure hosts/blades. For example, it is desirable to run profiling during the execution of a specific workload\non a guest/VM while running a steady/constant profiling on the host/blade underneath."}),"\n",(0,r.jsx)(n.h2,{id:"interval-based-profiling",children:"Interval-Based Profiling"}),"\n",(0,r.jsx)(n.p,{children:"The exact nature of how a given profiler works is dependent upon how it is implemented. The following section intends to provide a recommended\napproach to how a background monitor that runs a profiler should work when supporting interval-based profiling."}),"\n",(0,r.jsx)(n.h3,{id:"recommendations",children:"Recommendations:"}),"\n",(0,r.jsx)(n.p,{children:"Note that the recommendations below are largely implementation details."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Use the following examples for reference:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/microsoft/VirtualClient/blob/main/src/VirtualClient/VirtualClient.Monitors/ExampleProfilingMonitor.cs",children:"Example Monitor"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:'The profiler should be implemented as a background monitor so that it can be defined in a monitoring profile in the "Monitors" section.'}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"The specifics of the interval are defined in a monitoring profile. Monitoring profiles define a set of one or more monitors to run and any\nparameters that control the behaviors of the monitors. The following parameters are commonly used to define behaviors for interval-based profilers:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"ProfilingEnabled"}),(0,r.jsx)(n.br,{}),"\n","Defines true/false whether background profiling is enabled. This determines if the profiling toolsets associated with the monitors will be run."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"ProfilingMode"}),(0,r.jsx)(n.br,{}),"\n","Defines how/when profiling operations will occur (Interval vs. OnDemand). For interval-based profiling, this will be set to 'Interval'. If the\nmonitor supports both types of profiling, a profile-level parameter should be defined allowing this value to be overridden/defined on the command\nline (see the 'ExampleProfilerMode' parameter in the example below). Default = None (i.e. no specific profiling mode)."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"ProfilingPeriod"}),(0,r.jsx)(n.br,{}),"\n","Defines how long the profiler will run/execute to capture information from the system. For interval-based profiling, this will be a consistent\nperiod throughout the runtime execution of the Virtual Client. Default = TimeSpan.Zero (i.e. no profiling period)."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"ProfilingWarmUpPeriod"}),(0,r.jsx)(n.br,{}),"\n","Defines a period of time to wait before executing the profiler operations. After this period of time, the profiler will run for the amount of\ntime specified by the 'ProfilingPeriod'. Default = TimeSpan.Zero (i.e. no warm-up period)."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"ProfilingInterval"}),(0,r.jsx)(n.br,{}),"\n","Defines the interval to wait between each execution of the profiler. The profiler will execute at the beginning of each interval and will run\nfor a period of time as defined by the 'ProfilingPeriod'. For example given a 1 minute interval and 30 second profiling period, a profiler starting\nat 12:00:00 AM would run until 12:00:30 AM and would then wait until 12:01:00 AM before running again (for another 30 seconds).\nDefault = TimeSpan.Zero (i.e. profiler runs on non-stop intervals)."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"A Parameter to Enable Disable the Monitor"}),(0,r.jsx)(n.br,{}),"\n","Each individual monitor that runs a profiler should have a unique parameter that defines whether the profiler is enabled or not. Additionally, a\nprofile-level parameter should be defined so that this can be overridden/defined on the command line (see the 'ExampleProfilerEnabled' parameter in\nthe example below). Default = true (profiler is enabled by default)."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)("div",{class:"code-section",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "Description": "Example Monitoring Profile That Supports Interval + On-Demand Profiling.",\n  "Parameters": {\n      "ProfilingEnabled": true,\n      "ProfilingMode": "Interval"\n  },\n  "Monitors": [\n      {\n          "Type": "ExampleWorkloadProfilingScenarioMonitor",\n          "Parameters": {\n              "Scenario": "ProfileSystem",\n              "ExampleProfilerEnabled": "$.Parameters.ProfilingEnabled",\n              "ProfilingMode": "$.Parameters.ProfilingMode",\n              "ProfilingPeriod": "00:00:30",\n              "ProfilingInterval": "00:00:45",\n              "Tags": "Test,VC"\n          }\n      }\n  ]\n}\n'})})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"on-demand-profiling",children:"On-Demand Profiling"}),"\n",(0,r.jsx)(n.p,{children:"The exact nature of how a given profiler works is dependent upon how it is implemented. The following section intends to provide a recommended\napproach to how a background monitor that runs a profiler should work when supporting on-demand profiling. The Virtual Client utilizes standard\n.NET events to support on-demand behaviors. This enables real-time support for in-process notifications between workload executors and background\nmonitors."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/microsoft/VirtualClient/blob/main/src/VirtualClient/VirtualClient.Contracts/VirtualClientRuntime.cs",children:"VirtualClientRuntime Class"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/dotnet/standard/events/",children:".NET Events"})}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"recommendations-1",children:"Recommendations:"}),"\n",(0,r.jsx)(n.p,{children:'Note that the recommendations below are largely implementation details. In this implementation requirement there are one or more monitors that run profilers\ndefined in a monitoring profile who simply listen until signaled. The workload executors are defined in a workload profile. The workload executors\nsend signals to the monitors/profilers to run using simple .NET events where "instructions" are passed to the monitors/profilers.'}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Use the following examples for reference:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/microsoft/VirtualClient/blob/main/src/VirtualClient/VirtualClient.Examples/ExampleWorkloadProfilingScenarioExecutor.cs",children:"Example Workload Executor"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/microsoft/VirtualClient/blob/main/src/VirtualClient/VirtualClient.Examples/ExampleWorkloadProfilingScenarioMonitor.cs",children:"Example Monitor"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/microsoft/VirtualClient/tree/main/src/VirtualClient/VirtualClient.Examples/profiles",children:"Example Profiles"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:'The profiler should be implemented as a background monitor so that it can be defined in a monitoring profile in the "Monitors" section.'}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"The monitor should be defined in a monitoring profile (separate from any workload profiles)."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Parameters that define the behaviors of the on-demand monitor/profiler should be defined in a workload profile within the 'Parameters' section\nof each individual workload 'Action'. The following parameters are commonly used to define behaviors for on-demand profilers:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"ProfilingEnabled"}),(0,r.jsx)(n.br,{}),"\n","Defines true/false whether on-demand profiling is enabled for a particular workload 'Action'. A profile-level parameter should be defined that\nallows this value to be overridden/defined on the command line (see the 'OnDemandProfilingEnabled' parameter below)."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"ProfilingMode"}),(0,r.jsx)(n.br,{}),"\n","Defines how/when profiling operations will occur (Interval vs. OnDemand). For interval-based profiling, this will be set to 'Interval'. If the\nmonitor supports both types of profiling, a profile-level parameter should be defined allowing this value to be overridden/defined on the command\nline (see the 'ExampleProfilerMode' parameter in the example below). Default = None (i.e. no specific profiling mode)."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"ProfilingPeriod"}),(0,r.jsx)(n.br,{}),"\n","Defines how long the profiler will run/execute to capture information from the system. For interval-based profiling, this will be a consistent\nperiod throughout the runtime execution of the Virtual Client."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"ProfilingWarmUpPeriod"}),(0,r.jsx)(n.br,{}),"\n","Defines a period of time to wait before executing the profiler operations. After this period of time, the profiler will run for the amount of\ntime specified by the 'ProfilingPeriod'."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Cancellation on Workload Completion"}),(0,r.jsx)(n.br,{}),"\n","The monitor/profiler should honor the CancellationToken provided to it in the instructions sent by the workload executor when the 'ProfilingPeriod'\nis not defined (i.e. period == TimeSpan.Zero). This enables support for running the profiler for the entire length of time that the workload runs\nand stopping it promptly when the workload itself finishes."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)("div",{class:"code-section",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "Description": "Example Workload Profile That Supports On-Demand Profiling While Workload Run.",\n  "MinimumExecutionInterval": "00:00:05",\n  "Parameters": {\n      "ProfilingEnabled": false\n  },\n  "Actions": [\n      {\n          "Type": "ExampleWorkloadProfilingScenarioExecutor",\n          "Parameters": {\n              "Scenario": "Scenario1",\n              "WorkloadRuntime": "00:01:00",\n              "ProfilingEnabled": "$.Parameters.ProfilingEnabled",\n              "ProfilingPeriod": "00:00:30",\n              "ProfilingWarmUpPeriod": "00:00:10",\n              "Tags": "Test,VC"\n          }\n      },\n      {\n          "Type": "ExampleWorkloadProfilingScenarioExecutor",\n          "Parameters": {\n              "Scenario": "Scenario2",\n              "WorkloadRuntime": "00:00:30",\n              "ProfilingEnabled": "$.Parameters.ProfilingEnabled",\n              "ProfilingPeriod": "00:00:30",\n              "ProfilingWarmUpPeriod": "00:00:00",\n              "Tags": "Test,VC"\n          }\n      },\n      {\n          "Type": "ExampleWorkloadProfilingScenarioExecutor",\n          "Parameters": {\n              "Scenario": "Scenario3",\n              "WorkloadRuntime": "00:00:45",\n              "ProfilingEnabled": "$.Parameters.ProfilingEnabled",\n              "ProfilingWarmUpPeriod": "00:00:00",\n              "Tags": "Test,VC"\n          }\n      }\n  ]\n}\n'})})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"bringing-it-all-together",children:"Bringing it All Together"}),"\n",(0,r.jsxs)(n.p,{children:["The documentation above covers the essentials for how profilers are integrated into the Virtual Client application. One final thing to cover is the\nextent to which this integration applies. There is logic in the base ",(0,r.jsx)(n.a,{href:"https://github.com/microsoft/VirtualClient/blob/main/src/VirtualClient/VirtualClient.Contracts/VirtualClientComponent.cs",children:"VirtualClientComponent"})," class\nthat ensures this behavior is available for all workload executors that exist in the application. There is no need to make any code changes to individual\nworkload executors to enable profiling. Thus the parameters noted above in the section for on-demand profiling can be added to the parameters for and of\nthe workload 'Actions' to enable support for monitors/profilers supported by the application. Once these parameters have been added to an existing profile,\nthe user/automation can run workloads with profiling by simply defining the related profiles on the command line...a workload profile and a monitoring profile.\nThe two profiles will be merged into one."]}),"\n",(0,r.jsxs)("div",{class:"code-section",children:[(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'VirtualClient.exe --profile=PERF-NETWORK.json --profile=MONITORS-PROFILING.json --timeout=180 --packages="{BlobStoreConnectionString|SAS URI}" --parameters="OnDemandProfilingEnabled=true,,,AzureProfilerMode=OnDemand"\n'})}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'# PERF-NETWORK.json\n\n{\n    "Description": "Azure Networking Workload",\n    "Parameters": {\n        "ProfilingEnabled": false,\n        "ProfilingMode": "None"\n    },\n    "Actions": [\n        {\n            "Type": "NetworkingWorkloadSetupExecutor"\n        },\n        {\n            "Type": "NetworkingWorkloadExecutor",\n            "Parameters": {\n                "Scenario": "NTttcp_TCP_4K_Buffer_T1",\n                "ToolName": "NTttcp",\n                "PackageName": "Networking",\n                "Protocol": "TCP",\n                "ThreadCount": 1,\n                "BufferSize": "4K",\n                "TestDuration": "60",\n                "ProfilingEnabled": "$.Parameters.ProfilingEnabled",\n                "PowerShell7PackageName": "PowerShell7"\n            }\n        },\n        {\n            "Type": "NetworkingWorkloadExecutor",\n            "Parameters": {\n                "Scenario": "NTttcp_TCP_64K_Buffer_T1",\n                "ToolName": "NTttcp",\n                "PackageName": "Networking",\n                "Protocol": "TCP",\n                "ThreadCount": 1,\n                "BufferSize": "64K",\n                "TestDuration": "60",\n                "ProfilingEnabled": "$.Parameters.ProfilingEnabled",\n                "PowerShell7PackageName": "PowerShell7"\n            }\n        },\n        {\n            "Type": "NetworkingWorkloadExecutor",\n            "Parameters": {\n                "Scenario": "Latte_TCP",\n                "ToolName": "Latte",\n                "PackageName": "Networking",\n                "Protocol": "TCP",\n                "ProfilingEnabled": "$.Parameters.ProfilingEnabled",\n                "PowerShell7PackageName": "PowerShell7"\n            }\n        },\n        {\n            "Type": "NetworkingWorkloadExecutor",\n            "Parameters": {\n                "Scenario": "CPS",\n                "ToolName": "CPS",\n                "PackageName": "Networking",\n                "Connections": "16",\n                "TestDuration": "300",\n                "WarmupTime" : "60",\n                "ProfilingEnabled": "$.Parameters.ProfilingEnabled",\n                "PowerShell7PackageName": "PowerShell7"\n            }\n        }\n        ...\n    ]\n}\n'})}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'# MONITORS-PROFILING.json\n\n{\n    "Description": "Monitors for Profiling the System",\n    "Parameters": {\n        "ProfilingEnabled": true,\n        "ProfilingMode": "Interval"\n    },\n    "Monitors": [\n        {\n            "Type": "AzureProfilerMonitor",\n            "Parameters": {\n                "Scenario": "CaptureProfiles",\n                "ProfilingEnabled": "$.Parameters.ProfilingEnabled",\n                "ProfilingMode": "$.Parameters.ProfilingMode",\n                "ProfilingPeriod": "00:00:30",\n                "ProfilingInterval": "00:01:00",\n                "ProfilingWarmupPeriod": "00:00:00",\n                "ProfileDataUploadInterval": "00:00:30"\n            }\n        }\n        ...\n    ]\n}\n'})})]}),"\n",(0,r.jsx)(n.h2,{id:"profiling-integration-code-requirements",children:"Profiling Integration Code Requirements"}),"\n",(0,r.jsx)(n.p,{children:"It is necessary to make a small set of code changes to any workload executor that should support on-demand profiling. Note that this does not apply nor is\nit required to support interval-based profiling. Interval-based profiling takes no dependency on the workload executors for signals. The following section\ncovers the code changes that must be made to a workload executor."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Use the following examples for reference:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/microsoft/VirtualClient/blob/main/src/VirtualClient/VirtualClient.Examples/ExampleWorkloadProfilingScenarioExecutor.cs",children:"Example Workload Executor"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/microsoft/VirtualClient/blob/main/src/VirtualClient/VirtualClient.Core/BackgroundProfiling.cs",children:"BackgroundProfiling Class"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"add-a-backgroundprofiling-block",children:"Add a BackgroundProfiling Block"}),"\n",(0,r.jsx)(n.p,{children:"Each workload executor might perform a number of different operations before executing an actual workload. In order to allow each workload executor to be\ninstrumented such that on-demand profiling happens at exactly the right/desired moment, a BackgroundProfiling block will be added. The following example\nshows how to do this:"}),"\n",(0,r.jsx)("div",{class:"code-section",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:' protected override async Task ExecuteAsync(EventContext telemetryContext, CancellationToken cancellationToken)\n{\n    try\n    {\n        using (BackgroundProfiling profiling = BackgroundProfiling.Begin(this, cancellationToken))\n        {\n            using (process = this.SystemManagement.ProcessManager.CreateElevatedProcess(this.Platform, "C:\\any\\path\\to\\workload.exe", arguments))\n            {\n                // Workload will be executed here. This ensures that profiling will run during period precisely when\n                // the workload itself is running and can be stopped as soon as the workload exits. The exact behavior\n                // depends upon how the background monitor running the profiler is implemented. However, these type of\n                // background monitors are expected to be implemented following the recommendations above.\n                 await process.StartAndWaitAsync(cancellationToken, timeout)\n                     .ConfigureAwait(false);\n            }\n        }\n    }\n    catch (OperationCanceledException)\n    {\n        // Expected when a Task.Delay is cancelled.\n    }\n}\n\n'})})})]})}function h(e={}){const{wrapper:n}={...(0,o.ah)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},3905:(e,n,i)=>{i.d(n,{ah:()=>d});var r=i(7294);function o(e,n,i){return n in e?Object.defineProperty(e,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[n]=i,e}function t(e,n){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),i.push.apply(i,r)}return i}function l(e){for(var n=1;n<arguments.length;n++){var i=null!=arguments[n]?arguments[n]:{};n%2?t(Object(i),!0).forEach((function(n){o(e,n,i[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):t(Object(i)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(i,n))}))}return e}function a(e,n){if(null==e)return{};var i,r,o=function(e,n){if(null==e)return{};var i,r,o={},t=Object.keys(e);for(r=0;r<t.length;r++)i=t[r],n.indexOf(i)>=0||(o[i]=e[i]);return o}(e,n);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);for(r=0;r<t.length;r++)i=t[r],n.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(o[i]=e[i])}return o}var s=r.createContext({}),d=function(e){var n=r.useContext(s),i=n;return e&&(i="function"==typeof e?e(n):l(l({},n),e)),i},c={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},h=r.forwardRef((function(e,n){var i=e.components,o=e.mdxType,t=e.originalType,s=e.parentName,h=a(e,["components","mdxType","originalType","parentName"]),p=d(i),f=o,u=p["".concat(s,".").concat(f)]||p[f]||c[f]||t;return i?r.createElement(u,l(l({ref:n},h),{},{components:i})):r.createElement(u,l({ref:n},h))}));h.displayName="MDXCreateElement"}}]);