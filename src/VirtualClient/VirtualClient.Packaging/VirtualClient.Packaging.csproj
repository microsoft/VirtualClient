<Project Sdk="Microsoft.NET.Sdk">

	<PropertyGroup>
		<TargetFramework>net9.0</TargetFramework>
		<IsPackable>true</IsPackable>
		<NoWarn>NU5100;NU5110;NU5111;NU5118;NU5128;NU5131</NoWarn>
	</PropertyGroup>

	<!--
    Creates an empty placeholder file in the target output directory. This placeholder file
	is used in conjunction with .nuspec definitions to enable the creation of empty directories
	in NuGet packages.
    -->
	<Target Name="CreateEmptyPlaceholderFileInOutputDirectory" AfterTargets="Build">
		<WriteLinesToFile
			File="$(RepoPath)\out\temp\_._"
		    Lines=""
		    Overwrite="true"
		    Encoding="UTF-8"
		    />
	</Target>

	<Import Project="$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildThisFileDirectory), Module.props))\Module.props" />
	<Import Project="$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildThisFileDirectory), Module.props))\NuGetPackaging.targets" />

	<!-- 
	Generate the <NuspecProperties/> references to include the versions of all packages defined
	in the Directory.Packages.props file. These versions may be then referenced in the individual
	.nuspec files used to create the NuGet packages.
	-->
	<Target Name="BuildNuspecProperties" BeforeTargets="GenerateNuspec">
		<XmlPeek XmlInputPath="$(RepoPath)\Directory.Packages.props" Query="/Project/ItemGroup/PackageVersion">
			<Output TaskParameter="Result" ItemName="RawPackageVersions" />
		</XmlPeek>

		<ItemGroup>
			<PackageInfo Include="$([System.Text.RegularExpressions.Regex]::Match(%(RawPackageVersions.Identity), 'Include=&quot;(?&lt;name&gt;.*?)&quot;').Groups[&quot;name&quot;].Value.Replace('.', '_'))">
				<Version>$([System.Text.RegularExpressions.Regex]::Match(%(RawPackageVersions.Identity), 'Version=&quot;(?&lt;version&gt;.*?)&quot;').Groups[&quot;version&quot;].Value)</Version>
			</PackageInfo>
		</ItemGroup>

		<ItemGroup>
			<PackageVersions Include="%(PackageInfo.Identity)_Version=%(PackageInfo.Version)" />
		</ItemGroup>

		<PropertyGroup>
			<PackageOutDir>$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildThisFileDirectory), Repo.props))\out</PackageOutDir>
			<NuspecProperties>BinDir=$(PackageOutDir)\bin;BinConfigDir=$(PackageOutDir)\bin\$(Configuration);TempDir=$(PackageOutDir)\temp;Version=$(Version)</NuspecProperties>
			<NuspecProperties>$(NuspecProperties);@(PackageVersions)</NuspecProperties>
		</PropertyGroup>

		<Message Text="NuspecProperties = $(NuspecProperties)" Importance="high" />
	</Target>
</Project>
