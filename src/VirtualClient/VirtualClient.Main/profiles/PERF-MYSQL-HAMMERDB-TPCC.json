{
    "Description": "HammerDB MySQL TPCC Database Server Performance Workload",
    "MinimumExecutionInterval": "00:01:00",
    "Metadata": {
        "RecommendedMinimumExecutionTime": "04:00:00",
        "SupportedPlatforms": "linux-x64",
        "SupportedOperatingSystems": "Debian,Ubuntu"
    },
    "Parameters": {
        "DatabaseName": "hammerdb_tpcc",
        "DiskFilter": "osdisk:false&sizegreaterthan:256g",
        "Port": "3306",
        "Duration": "00:20:00",
        "VirtualUsers": "{calculate({LogicalCoreCount})}",
        "WarehouseCount": "{calculate({SystemMemoryMegabytes} * 15 / 800)}",
        "InnodbBufferPoolSize": "{calculate({SystemMemoryBytes} * 80 / 100)}"
    },
    "Actions": [
        {
            "Type": "HammerDBServerExecutor",
            "Parameters": {
                "Scenario": "ExecuteServer",
                "PackageName": "hammerdb",
                "Workload": "tpcc",
                "SQLServer": "mysql",
                "DatabaseName": "$.Parameters.DatabaseName",
                "Port": "$.Parameters.Port",
                "VirtualUsers": "$.Parameters.VirtualUsers",
                "WarehouseCount": "$.Parameters.WarehouseCount",
                "Duration": "$.Parameters.Duration",
                "Role": "Server"
            }
        },
        {
            "Type": "HammerDBClientExecutor",
            "Parameters": {
                "Scenario": "tpcc",
                "Workload": "tpcc",
                "SQLServer": "mysql",
                "PackageName": "hammerdb",
                "DatabaseName": "$.Parameters.DatabaseName",
                "Port": "$.Parameters.Port",
                "VirtualUsers": "$.Parameters.VirtualUsers",
                "WarehouseCount": "$.Parameters.WarehouseCount",
                "Duration": "$.Parameters.Duration",
                "Role": "Client"
            }
        }
    ],
    "Dependencies": [
        {
            "Type": "FormatDisks",
            "Parameters": {
                "Scenario": "FormatDisks",
                "Role": "Server"
            }
        },
        {
            "Type": "MountDisks",
            "Parameters": {
                "Scenario": "CreateMountPoints",
                "Role": "Server"
            }
        },
        {
            "Type": "LinuxPackageInstallation",
            "Parameters": {
                "Scenario": "InstallLinuxPackages",
                "Packages": "python3,libmysqlclient-dev"
            }
        },
        {
            "Type": "DependencyPackageInstallation",
            "Parameters": {
                "Scenario": "DownloadMySqlServerPackage",
                "BlobContainer": "packages",
                "BlobName": "mysql.8.0.36.rev4.zip",
                "PackageName": "mysql-server",
                "Extract": true,
                "Role": "Server"
            }
        },
        {
            "Type": "DependencyPackageInstallation",
            "Parameters": {
                "Scenario": "DownloadHammerDBPackage",
                "BlobContainer": "packages",
                "BlobName": "hammerdb.4.12.0.rev3.zip",
                "PackageName": "hammerdb",
                "Extract": true
            }
        },
        {
            "Type": "MySQLServerInstallation",
            "Parameters": {
                "Scenario": "InstallMySQLServer",
                "Action": "InstallServer",
                "Benchmark": "TPCC",
                "PackageName": "mysql-server",
                "Role": "Server"
            }
        },
        {
            "Type": "MySQLServerConfiguration",
            "Parameters": {
                "Scenario": "ConfigureMySQLServer",
                "Action": "ConfigureServer",
                "Benchmark": "TPCC",
                "DiskFilter": "$.Parameters.DiskFilter",
                "PackageName": "mysql-server",
                "Role": "Server"
            }
        },
        {
            "Type": "MySQLServerConfiguration",
            "Parameters": {
                "Scenario": "SetMySQLGlobalVariables",
                "Action": "SetGlobalVariables",
                "Benchmark": "TPCC",
                "InnodbBufferPoolSize": "$.Parameters.InnodbBufferPoolSize",
                "Variables": "MAX_PREPARED_STMT_COUNT=1000000;MAX_CONNECTIONS=100000;innodb_buffer_pool_size={InnodbBufferPoolSize};innodb_lock_wait_timeout=300;innodb_io_capacity=10000;innodb_io_capacity_max=10000;innodb_buffer_pool_dump_at_shutdown=OFF;innodb_change_buffering=0;table_open_cache=20000;",
                "PackageName": "mysql-server",
                "Role": "Server"
            }
        },
        {
            "Type": "MySQLServerConfiguration",
            "Parameters": {
                "Scenario": "CreateMySQLDatabase",
                "Action": "CreateDatabase",
                "Benchmark": "TPCC",
                "DatabaseName": "$.Parameters.DatabaseName",
                "PackageName": "mysql-server",
                "Role": "Server"
            }
        },
        {
            "Type": "HammerDBExecutor",
            "Parameters": {
                "Scenario": "PopulateMySQLDatabase",
                "DatabaseName": "$.Parameters.DatabaseName",
                "Workload": "tpcc",
                "SQLServer": "mysql",
                "PackageName": "hammerdb",
                "VirtualUsers": "$.Parameters.VirtualUsers",
                "WarehouseCount": "$.Parameters.WarehouseCount",
                "Port": "$.Parameters.Port",
                "Duration": "$.Parameters.Duration",
                "Role": "Server"
            }
        },
        {
            "Type": "MySQLServerConfiguration",
            "Parameters": {
                "Scenario": "DistributeMySQLDatabase",
                "Action": "DistributeDatabase",
                "DatabaseName": "$.Parameters.DatabaseName",
                "DiskFilter": "$.Parameters.DiskFilter",
                "PackageName": "mysql-server",
                "Role": "Server"
            }
        },
        {
            "Type": "ApiServer",
            "Parameters": {
                "Scenario": "StartAPIServer",
                "Role": "Server"
            }
        }
    ]
}