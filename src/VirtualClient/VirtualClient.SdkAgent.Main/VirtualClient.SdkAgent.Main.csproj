<Project Sdk="Microsoft.NET.Sdk">

    <PropertyGroup>
        <OutputType>Exe</OutputType>
        <TargetFramework>net9.0</TargetFramework>
        <AssemblyName>SdkAgent</AssemblyName>
        <RootNamespace>VirtualClient</RootNamespace>
        <RuntimeIdentifiers>win-x64;linux-x64;win-arm64;linux-arm64</RuntimeIdentifiers>
        <RunAnalyzers>false</RunAnalyzers>
        <NoWarn>CA1416;NU5100;NU5118;NU5128;SA1118;NU5110;NU5111;IL2026;IL2104;IL2072</NoWarn>
        <SatelliteResourceLanguages>en</SatelliteResourceLanguages>
        <BuildPropertyOutput Condition="'$(RuntimeIdentifier)' != ''">true</BuildPropertyOutput>
		<DefineConstants>$(DefineConstants);SDK_AGENT</DefineConstants>
    </PropertyGroup>

    <ItemGroup>
        <!-- Global package dependency versions are defined in the Module.props for the solution. -->
        <PackageReference Include="System.CommandLine" />
        <PackageReference Include="System.ServiceProcess.ServiceController" />
    </ItemGroup>

    <ItemGroup>
        <ProjectReference Include="..\VirtualClient.Actions\VirtualClient.Actions.csproj" />
        <ProjectReference Include="..\VirtualClient.Api\VirtualClient.Api.csproj" />
        <ProjectReference Include="..\VirtualClient.Contracts\VirtualClient.Contracts.csproj" />
        <ProjectReference Include="..\VirtualClient.Controller\VirtualClient.Controller.csproj" />
        <ProjectReference Include="..\VirtualClient.Dependencies\VirtualClient.Dependencies.csproj" />
        <ProjectReference Include="..\VirtualClient.Monitors\VirtualClient.Monitors.csproj" />
    </ItemGroup>

	<!-- Link ALL files required to build the SDK package to this project -->
	<ItemGroup>
		<Compile Include="..\VirtualClient.Main\**\*.cs">
			<Link>%(RecursiveDir)%(Filename)%(Extension)</Link>
		</Compile>

		<None Include="..\VirtualClient.Main\profiles\*.*">
			<Link>profiles\%(RecursiveDir)%(Filename)%(Extension)</Link>
			<CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
		</None>

		<None Include="..\VirtualClient.Main\profiles\agent\*.*">
			<Link>profiles\%(RecursiveDir)%(Filename)%(Extension)</Link>
			<CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
		</None>

		<None Include="..\VirtualClient.Main\tools\**\*.*">
			<Link>tools\%(RecursiveDir)%(Filename)%(Extension)</Link>
			<CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
		</None>
	</ItemGroup>
	<ItemGroup>
	  <Content Include="..\VirtualClient.Main\appsettings.json" Link="appsettings.json" />
	</ItemGroup>
    
    <!--
    Sets the target publish directory. In practice, this should be the same as the output path as there
    is no need to duplicate the build output into a separate directory. The build output directory and
    publish directory are the same.
    -->
    <Target Name="SetPublishDirectory" BeforeTargets="Build">     
        <PropertyGroup>
            <PublishDir>$(OutputPath)</PublishDir>
        </PropertyGroup>
    </Target>
    
    <!--
    Copies script/content files into the target output directory.
    -->
    <Target Name="CopyScriptsToOutputDirectory" AfterTargets="Build">
        <ItemGroup>
            <ScriptFiles Include="$(RepoPath)\out\scripts\**\*.*" />
        </ItemGroup>

        <Copy SourceFiles="@(ScriptFiles)" DestinationFiles="@(ScriptFiles->'$(OutputPath)scripts\%(RecursiveDir)%(Filename)%(Extension)')" />
    </Target>

    <!--
    Creates the "packages" directory in the target output directory.
    -->
    <Target Name="CreatePackagesAndToolsOutputDirectory" AfterTargets="Build">
        <MakeDir Directories="$(OutputPath)packages" />
		<MakeDir Directories="$(OutputPath)temp" />
    </Target>

    <Import Project="$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildThisFileDirectory), Module.props))\Module.props" />
    <Import Project="$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildThisFileDirectory), Module.props))\NuGetPackaging.targets" />

</Project>
