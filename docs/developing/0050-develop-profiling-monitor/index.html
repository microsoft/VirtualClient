<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-developing/0050-develop-profiling-monitor" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.0">
<title data-rh="true">Profiler Integration | Virtual Client Platform</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://microsoft.github.io/VirtualClient/docs/developing/0050-develop-profiling-monitor/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="keywords" content="performance, benchmarking, automation, framework, microsoft"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Profiler Integration | Virtual Client Platform"><meta data-rh="true" name="description" content="Profilers are applications/programs that are used to capture very detailed information for operations that are happening on the"><meta data-rh="true" property="og:description" content="Profilers are applications/programs that are used to capture very detailed information for operations that are happening on the"><link data-rh="true" rel="icon" href="/VirtualClient/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://microsoft.github.io/VirtualClient/docs/developing/0050-develop-profiling-monitor/"><link data-rh="true" rel="alternate" href="https://microsoft.github.io/VirtualClient/docs/developing/0050-develop-profiling-monitor/" hreflang="en"><link data-rh="true" rel="alternate" href="https://microsoft.github.io/VirtualClient/docs/developing/0050-develop-profiling-monitor/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://0I7D8A07MA-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/VirtualClient/blog/rss.xml" title="Virtual Client Platform RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/VirtualClient/blog/atom.xml" title="Virtual Client Platform Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Virtual Client Platform" href="/VirtualClient/opensearch.xml"><link rel="stylesheet" href="/VirtualClient/assets/css/styles.9af2558c.css">
<script src="/VirtualClient/assets/js/runtime~main.21841306.js" defer="defer"></script>
<script src="/VirtualClient/assets/js/main.cea975e9.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">⭐️ If you like VirtualClient, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/microsoft/VirtualClient">GitHub</a> ⭐️</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/VirtualClient/"><div class="navbar__logo"><img src="/VirtualClient/img/vc-logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/VirtualClient/img/vc-logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Virtual Client</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/VirtualClient/docs/overview/">Documentation</a><a class="navbar__item navbar__link" href="/VirtualClient/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/microsoft/VirtualClient" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/VirtualClient/docs/category/overview/">Overview</a><button aria-label="Expand sidebar category &#x27;Overview&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/VirtualClient/docs/category/guides/">Guides</a><button aria-label="Expand sidebar category &#x27;Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/VirtualClient/docs/category/workloads/">Workloads</a><button aria-label="Expand sidebar category &#x27;Workloads&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/VirtualClient/docs/category/monitors/">Monitors</a><button aria-label="Expand sidebar category &#x27;Monitors&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/VirtualClient/docs/category/dependencies/">Dependencies</a><button aria-label="Expand sidebar category &#x27;Dependencies&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/VirtualClient/docs/category/developing/">Developing</a><button aria-label="Collapse sidebar category &#x27;Developing&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/VirtualClient/docs/developing/0001-ci-cd/">Automated Build and CI/CD pipeline</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/VirtualClient/docs/developing/0010-develop-guide/">Developer Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/VirtualClient/docs/developing/0020-develop-extensions/">Developing Extensions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/VirtualClient/docs/developing/0021-run-custom-scripts/">Run Custom Scripts with Virtual Client</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/VirtualClient/docs/developing/0030-workload-onboarding/">Workload Onboarding Process</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/VirtualClient/docs/developing/0040-vc-packages/">VC Packages</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/VirtualClient/docs/developing/0050-develop-profiling-monitor/">Profiler Integration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/VirtualClient/docs/developing/0060-workload-recommendations/">Workload Selection Recommendations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/VirtualClient/docs/developing/0061-build-docker-container/">Building Docker Containers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/VirtualClient/docs/developing/0070-error-handling/">Error Handling Recommendations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/VirtualClient/docs/developing/0080-coding-standards/">Coding Standards</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/VirtualClient/docs/developing/0090-testing/">Testing Practices</a></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/VirtualClient/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/VirtualClient/docs/category/developing/"><span itemprop="name">Developing</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Profiler Integration</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1 id="profiler-integration">Profiler Integration</h1>
<p>Profilers are applications/programs that are used to capture very detailed information for operations that are happening on the
system. For example, the <a href="https://eng.ms/docs/products/azure-profiler/azure-profiler">Azure Profiler</a> is a toolet that captures
detailed information for various types of low level operations on the system such as CPU callstacks, memory usage, and context
switches. The following sections cover support that exists in the Virtual Client for profilers as well as how that is enabled in
workload and monitoring profiles.</p>
<h2 id="preliminaries">Preliminaries</h2>
<p>The following pieces of documentation are helpful to understand before implementing any new monitor or profiler support in the
Virtual Client.</p>
<ul>
<li><a href="https://github.com/microsoft/VirtualClient/blob/main/website/docs/overview/features.md">Platform Overview</a></li>
<li><a href="https://github.com/microsoft/VirtualClient/blob/main/website/docs/overview/design.md">Platform Design Aspects</a></li>
</ul>
<p>Note that there is a project in the Virtual Client solution that showcases both interval-based as well as on-demand profiling
scenarios. From Visual Studio, you can set the project <a href="https://msazure.visualstudio.com/One/_git/CRC-AIR-Workloads?path=/src/VirtualClient/VirtualClient.Examples">VirtualClient.Examples</a>
as the startup project and run it. Select option #2 on the initial menu to see an example of interval-based profiling. Select option #3
on the initial menu to see an example of interval-based monitoring. These are just examples so no actual system profiling is happening,
but this illustrates the code flow and can be debugged in the Visual Studio IDE.</p>
<h2 id="supported-profilers">Supported Profilers</h2>
<p>The following profilers are currently supported by the Virtual Client:</p>
<ul>
<li><a href="https://eng.ms/docs/products/azure-profiler/azure-profiler">Azure Profiler</a></li>
</ul>
<h2 id="profiling-scenarios">Profiling Scenarios</h2>
<p>The Virtual Client supports a few different profiling scenarios designed to enable flexibility with the capture of information from the
system:</p>
<ul>
<li>
<p><strong>Interval-Based Profiling</strong><br>
<!-- -->Interval-based profiling involves running a profiler on consistent intervals constantly throughout the runtime execution of the Virtual
Client.</p>
</li>
<li>
<p><strong>On-Demand Profiling</strong><br>
<!-- -->On-demand profiling involves running a profiler only when signaled and for a length of time defined by the component that initiated the
signal. For example, a workload executor might want to have profiling run in the background for the duration that the workload itself runs
and no longer.</p>
</li>
</ul>
<p>It is recommended that you consider implementing both scenarios in monitors that run profilers. Both scenarios are useful for various needs
when running on Azure guests/VMs vs. Azure hosts/blades. For example, it is desirable to run profiling during the execution of a specific workload
on a guest/VM while running a steady/constant profiling on the host/blade underneath.</p>
<h2 id="interval-based-profiling">Interval-Based Profiling</h2>
<p>The exact nature of how a given profiler works is dependent upon how it is implemented. The following section intends to provide a recommended
approach to how a background monitor that runs a profiler should work when supporting interval-based profiling.</p>
<h3 id="recommendations">Recommendations:</h3>
<p>Note that the recommendations below are largely implementation details.</p>
<ul>
<li>
<p>Use the following examples for reference:</p>
<ul>
<li><a href="https://github.com/microsoft/VirtualClient/blob/main/src/VirtualClient/VirtualClient.Monitors/ExampleProfilingMonitor.cs">Example Monitor</a></li>
</ul>
</li>
<li>
<p>The profiler should be implemented as a background monitor so that it can be defined in a monitoring profile in the &quot;Monitors&quot; section.</p>
</li>
<li>
<p>The specifics of the interval are defined in a monitoring profile. Monitoring profiles define a set of one or more monitors to run and any
parameters that control the behaviors of the monitors. The following parameters are commonly used to define behaviors for interval-based profilers:</p>
<ul>
<li>
<p><strong>ProfilingEnabled</strong><br>
<!-- -->Defines true/false whether background profiling is enabled. This determines if the profiling toolsets associated with the monitors will be run.</p>
</li>
<li>
<p><strong>ProfilingMode</strong><br>
<!-- -->Defines how/when profiling operations will occur (Interval vs. OnDemand). For interval-based profiling, this will be set to &#x27;Interval&#x27;. If the
monitor supports both types of profiling, a profile-level parameter should be defined allowing this value to be overridden/defined on the command
line (see the &#x27;ExampleProfilerMode&#x27; parameter in the example below). Default = None (i.e. no specific profiling mode).</p>
</li>
<li>
<p><strong>ProfilingPeriod</strong><br>
<!-- -->Defines how long the profiler will run/execute to capture information from the system. For interval-based profiling, this will be a consistent
period throughout the runtime execution of the Virtual Client. Default = TimeSpan.Zero (i.e. no profiling period).</p>
</li>
<li>
<p><strong>ProfilingWarmUpPeriod</strong><br>
<!-- -->Defines a period of time to wait before executing the profiler operations. After this period of time, the profiler will run for the amount of
time specified by the &#x27;ProfilingPeriod&#x27;. Default = TimeSpan.Zero (i.e. no warm-up period).</p>
</li>
<li>
<p><strong>ProfilingInterval</strong><br>
<!-- -->Defines the interval to wait between each execution of the profiler. The profiler will execute at the beginning of each interval and will run
for a period of time as defined by the &#x27;ProfilingPeriod&#x27;. For example given a 1 minute interval and 30 second profiling period, a profiler starting
at 12:00:00 AM would run until 12:00:30 AM and would then wait until 12:01:00 AM before running again (for another 30 seconds).
Default = TimeSpan.Zero (i.e. profiler runs on non-stop intervals).</p>
</li>
<li>
<p><strong>A Parameter to Enable Disable the Monitor</strong><br>
<!-- -->Each individual monitor that runs a profiler should have a unique parameter that defines whether the profiler is enabled or not. Additionally, a
profile-level parameter should be defined so that this can be overridden/defined on the command line (see the &#x27;ExampleProfilerEnabled&#x27; parameter in
the example below). Default = true (profiler is enabled by default).</p>
</li>
</ul>
<div class="code-section"><pre><code class="language-json">{
  &quot;Description&quot;: &quot;Example Monitoring Profile That Supports Interval + On-Demand Profiling.&quot;,
  &quot;Parameters&quot;: {
      &quot;ProfilingEnabled&quot;: true,
      &quot;ProfilingMode&quot;: &quot;Interval&quot;
  },
  &quot;Monitors&quot;: [
      {
          &quot;Type&quot;: &quot;ExampleWorkloadProfilingScenarioMonitor&quot;,
          &quot;Parameters&quot;: {
              &quot;Scenario&quot;: &quot;ProfileSystem&quot;,
              &quot;ExampleProfilerEnabled&quot;: &quot;$.Parameters.ProfilingEnabled&quot;,
              &quot;ProfilingMode&quot;: &quot;$.Parameters.ProfilingMode&quot;,
              &quot;ProfilingPeriod&quot;: &quot;00:00:30&quot;,
              &quot;ProfilingInterval&quot;: &quot;00:00:45&quot;,
              &quot;Tags&quot;: &quot;Test,VC&quot;
          }
      }
  ]
}
</code></pre></div>
</li>
</ul>
<h2 id="on-demand-profiling">On-Demand Profiling</h2>
<p>The exact nature of how a given profiler works is dependent upon how it is implemented. The following section intends to provide a recommended
approach to how a background monitor that runs a profiler should work when supporting on-demand profiling. The Virtual Client utilizes standard
.NET events to support on-demand behaviors. This enables real-time support for in-process notifications between workload executors and background
monitors.</p>
<ul>
<li><a href="https://github.com/microsoft/VirtualClient/blob/main/src/VirtualClient/VirtualClient.Contracts/VirtualClientRuntime.cs">VirtualClientRuntime Class</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/standard/events/">.NET Events</a></li>
</ul>
<h3 id="recommendations-1">Recommendations:</h3>
<p>Note that the recommendations below are largely implementation details. In this implementation requirement there are one or more monitors that run profilers
defined in a monitoring profile who simply listen until signaled. The workload executors are defined in a workload profile. The workload executors
send signals to the monitors/profilers to run using simple .NET events where &quot;instructions&quot; are passed to the monitors/profilers.</p>
<ul>
<li>
<p>Use the following examples for reference:</p>
<ul>
<li><a href="https://github.com/microsoft/VirtualClient/blob/main/src/VirtualClient/VirtualClient.Examples/ExampleWorkloadProfilingScenarioExecutor.cs">Example Workload Executor</a></li>
<li><a href="https://github.com/microsoft/VirtualClient/blob/main/src/VirtualClient/VirtualClient.Examples/ExampleWorkloadProfilingScenarioMonitor.cs">Example Monitor</a></li>
<li><a href="https://github.com/microsoft/VirtualClient/tree/main/src/VirtualClient/VirtualClient.Examples/profiles">Example Profiles</a></li>
</ul>
</li>
<li>
<p>The profiler should be implemented as a background monitor so that it can be defined in a monitoring profile in the &quot;Monitors&quot; section.</p>
</li>
<li>
<p>The monitor should be defined in a monitoring profile (separate from any workload profiles).</p>
</li>
<li>
<p>Parameters that define the behaviors of the on-demand monitor/profiler should be defined in a workload profile within the &#x27;Parameters&#x27; section
of each individual workload &#x27;Action&#x27;. The following parameters are commonly used to define behaviors for on-demand profilers:</p>
<ul>
<li>
<p><strong>ProfilingEnabled</strong><br>
<!-- -->Defines true/false whether on-demand profiling is enabled for a particular workload &#x27;Action&#x27;. A profile-level parameter should be defined that
allows this value to be overridden/defined on the command line (see the &#x27;OnDemandProfilingEnabled&#x27; parameter below).</p>
</li>
<li>
<p><strong>ProfilingMode</strong><br>
<!-- -->Defines how/when profiling operations will occur (Interval vs. OnDemand). For interval-based profiling, this will be set to &#x27;Interval&#x27;. If the
monitor supports both types of profiling, a profile-level parameter should be defined allowing this value to be overridden/defined on the command
line (see the &#x27;ExampleProfilerMode&#x27; parameter in the example below). Default = None (i.e. no specific profiling mode).</p>
</li>
<li>
<p><strong>ProfilingPeriod</strong><br>
<!-- -->Defines how long the profiler will run/execute to capture information from the system. For interval-based profiling, this will be a consistent
period throughout the runtime execution of the Virtual Client.</p>
</li>
<li>
<p><strong>ProfilingWarmUpPeriod</strong><br>
<!-- -->Defines a period of time to wait before executing the profiler operations. After this period of time, the profiler will run for the amount of
time specified by the &#x27;ProfilingPeriod&#x27;.</p>
</li>
<li>
<p><strong>Cancellation on Workload Completion</strong><br>
<!-- -->The monitor/profiler should honor the CancellationToken provided to it in the instructions sent by the workload executor when the &#x27;ProfilingPeriod&#x27;
is not defined (i.e. period == TimeSpan.Zero). This enables support for running the profiler for the entire length of time that the workload runs
and stopping it promptly when the workload itself finishes.</p>
</li>
</ul>
<div class="code-section"><pre><code class="language-json">{
  &quot;Description&quot;: &quot;Example Workload Profile That Supports On-Demand Profiling While Workload Run.&quot;,
  &quot;MinimumExecutionInterval&quot;: &quot;00:00:05&quot;,
  &quot;Parameters&quot;: {
      &quot;ProfilingEnabled&quot;: false
  },
  &quot;Actions&quot;: [
      {
          &quot;Type&quot;: &quot;ExampleWorkloadProfilingScenarioExecutor&quot;,
          &quot;Parameters&quot;: {
              &quot;Scenario&quot;: &quot;Scenario1&quot;,
              &quot;WorkloadRuntime&quot;: &quot;00:01:00&quot;,
              &quot;ProfilingEnabled&quot;: &quot;$.Parameters.ProfilingEnabled&quot;,
              &quot;ProfilingPeriod&quot;: &quot;00:00:30&quot;,
              &quot;ProfilingWarmUpPeriod&quot;: &quot;00:00:10&quot;,
              &quot;Tags&quot;: &quot;Test,VC&quot;
          }
      },
      {
          &quot;Type&quot;: &quot;ExampleWorkloadProfilingScenarioExecutor&quot;,
          &quot;Parameters&quot;: {
              &quot;Scenario&quot;: &quot;Scenario2&quot;,
              &quot;WorkloadRuntime&quot;: &quot;00:00:30&quot;,
              &quot;ProfilingEnabled&quot;: &quot;$.Parameters.ProfilingEnabled&quot;,
              &quot;ProfilingPeriod&quot;: &quot;00:00:30&quot;,
              &quot;ProfilingWarmUpPeriod&quot;: &quot;00:00:00&quot;,
              &quot;Tags&quot;: &quot;Test,VC&quot;
          }
      },
      {
          &quot;Type&quot;: &quot;ExampleWorkloadProfilingScenarioExecutor&quot;,
          &quot;Parameters&quot;: {
              &quot;Scenario&quot;: &quot;Scenario3&quot;,
              &quot;WorkloadRuntime&quot;: &quot;00:00:45&quot;,
              &quot;ProfilingEnabled&quot;: &quot;$.Parameters.ProfilingEnabled&quot;,
              &quot;ProfilingWarmUpPeriod&quot;: &quot;00:00:00&quot;,
              &quot;Tags&quot;: &quot;Test,VC&quot;
          }
      }
  ]
}
</code></pre></div>
</li>
</ul>
<h2 id="bringing-it-all-together">Bringing it All Together</h2>
<p>The documentation above covers the essentials for how profilers are integrated into the Virtual Client application. One final thing to cover is the
extent to which this integration applies. There is logic in the base <a href="https://github.com/microsoft/VirtualClient/blob/main/src/VirtualClient/VirtualClient.Contracts/VirtualClientComponent.cs">VirtualClientComponent</a> class
that ensures this behavior is available for all workload executors that exist in the application. There is no need to make any code changes to individual
workload executors to enable profiling. Thus the parameters noted above in the section for on-demand profiling can be added to the parameters for and of
the workload &#x27;Actions&#x27; to enable support for monitors/profilers supported by the application. Once these parameters have been added to an existing profile,
the user/automation can run workloads with profiling by simply defining the related profiles on the command line...a workload profile and a monitoring profile.
The two profiles will be merged into one.</p>
<div class="code-section"><pre><code>VirtualClient.exe --profile=PERF-NETWORK.json --profile=MONITORS-PROFILING.json --timeout=180 --packages=&quot;{BlobStoreConnectionString|SAS URI}&quot; --parameters=&quot;OnDemandProfilingEnabled=true,,,AzureProfilerMode=OnDemand&quot;
</code></pre><pre><code class="language-json"># PERF-NETWORK.json

{
    &quot;Description&quot;: &quot;Azure Networking Workload&quot;,
    &quot;Parameters&quot;: {
        &quot;ProfilingEnabled&quot;: false,
        &quot;ProfilingMode&quot;: &quot;None&quot;
    },
    &quot;Actions&quot;: [
        {
            &quot;Type&quot;: &quot;NetworkingWorkloadSetupExecutor&quot;
        },
        {
            &quot;Type&quot;: &quot;NetworkingWorkloadExecutor&quot;,
            &quot;Parameters&quot;: {
                &quot;Scenario&quot;: &quot;NTttcp_TCP_4K_Buffer_T1&quot;,
                &quot;ToolName&quot;: &quot;NTttcp&quot;,
                &quot;PackageName&quot;: &quot;Networking&quot;,
                &quot;Protocol&quot;: &quot;TCP&quot;,
                &quot;ThreadCount&quot;: 1,
                &quot;BufferSize&quot;: &quot;4K&quot;,
                &quot;TestDuration&quot;: &quot;60&quot;,
                &quot;ProfilingEnabled&quot;: &quot;$.Parameters.ProfilingEnabled&quot;,
                &quot;PowerShell7PackageName&quot;: &quot;PowerShell7&quot;
            }
        },
        {
            &quot;Type&quot;: &quot;NetworkingWorkloadExecutor&quot;,
            &quot;Parameters&quot;: {
                &quot;Scenario&quot;: &quot;NTttcp_TCP_64K_Buffer_T1&quot;,
                &quot;ToolName&quot;: &quot;NTttcp&quot;,
                &quot;PackageName&quot;: &quot;Networking&quot;,
                &quot;Protocol&quot;: &quot;TCP&quot;,
                &quot;ThreadCount&quot;: 1,
                &quot;BufferSize&quot;: &quot;64K&quot;,
                &quot;TestDuration&quot;: &quot;60&quot;,
                &quot;ProfilingEnabled&quot;: &quot;$.Parameters.ProfilingEnabled&quot;,
                &quot;PowerShell7PackageName&quot;: &quot;PowerShell7&quot;
            }
        },
        {
            &quot;Type&quot;: &quot;NetworkingWorkloadExecutor&quot;,
            &quot;Parameters&quot;: {
                &quot;Scenario&quot;: &quot;Latte_TCP&quot;,
                &quot;ToolName&quot;: &quot;Latte&quot;,
                &quot;PackageName&quot;: &quot;Networking&quot;,
                &quot;Protocol&quot;: &quot;TCP&quot;,
                &quot;ProfilingEnabled&quot;: &quot;$.Parameters.ProfilingEnabled&quot;,
                &quot;PowerShell7PackageName&quot;: &quot;PowerShell7&quot;
            }
        },
        {
            &quot;Type&quot;: &quot;NetworkingWorkloadExecutor&quot;,
            &quot;Parameters&quot;: {
                &quot;Scenario&quot;: &quot;CPS&quot;,
                &quot;ToolName&quot;: &quot;CPS&quot;,
                &quot;PackageName&quot;: &quot;Networking&quot;,
                &quot;Connections&quot;: &quot;16&quot;,
                &quot;TestDuration&quot;: &quot;300&quot;,
                &quot;WarmupTime&quot; : &quot;60&quot;,
                &quot;ProfilingEnabled&quot;: &quot;$.Parameters.ProfilingEnabled&quot;,
                &quot;PowerShell7PackageName&quot;: &quot;PowerShell7&quot;
            }
        }
        ...
    ]
}
</code></pre><pre><code class="language-json"># MONITORS-PROFILING.json

{
    &quot;Description&quot;: &quot;Monitors for Profiling the System&quot;,
    &quot;Parameters&quot;: {
        &quot;ProfilingEnabled&quot;: true,
        &quot;ProfilingMode&quot;: &quot;Interval&quot;
    },
    &quot;Monitors&quot;: [
        {
            &quot;Type&quot;: &quot;AzureProfilerMonitor&quot;,
            &quot;Parameters&quot;: {
                &quot;Scenario&quot;: &quot;CaptureProfiles&quot;,
                &quot;ProfilingEnabled&quot;: &quot;$.Parameters.ProfilingEnabled&quot;,
                &quot;ProfilingMode&quot;: &quot;$.Parameters.ProfilingMode&quot;,
                &quot;ProfilingPeriod&quot;: &quot;00:00:30&quot;,
                &quot;ProfilingInterval&quot;: &quot;00:01:00&quot;,
                &quot;ProfilingWarmupPeriod&quot;: &quot;00:00:00&quot;,
                &quot;ProfileDataUploadInterval&quot;: &quot;00:00:30&quot;
            }
        }
        ...
    ]
}
</code></pre></div>
<h2 id="profiling-integration-code-requirements">Profiling Integration Code Requirements</h2>
<p>It is necessary to make a small set of code changes to any workload executor that should support on-demand profiling. Note that this does not apply nor is
it required to support interval-based profiling. Interval-based profiling takes no dependency on the workload executors for signals. The following section
covers the code changes that must be made to a workload executor.</p>
<ul>
<li>Use the following examples for reference:<!-- -->
<ul>
<li><a href="https://github.com/microsoft/VirtualClient/blob/main/src/VirtualClient/VirtualClient.Examples/ExampleWorkloadProfilingScenarioExecutor.cs">Example Workload Executor</a></li>
<li><a href="https://github.com/microsoft/VirtualClient/blob/main/src/VirtualClient/VirtualClient.Core/BackgroundProfiling.cs">BackgroundProfiling Class</a></li>
</ul>
</li>
</ul>
<h3 id="add-a-backgroundprofiling-block">Add a BackgroundProfiling Block</h3>
<p>Each workload executor might perform a number of different operations before executing an actual workload. In order to allow each workload executor to be
instrumented such that on-demand profiling happens at exactly the right/desired moment, a BackgroundProfiling block will be added. The following example
shows how to do this:</p>
<div class="code-section"><pre><code class="language-csharp"> protected override async Task ExecuteAsync(EventContext telemetryContext, CancellationToken cancellationToken)
{
    try
    {
        using (BackgroundProfiling profiling = BackgroundProfiling.Begin(this, cancellationToken))
        {
            using (process = this.SystemManagement.ProcessManager.CreateElevatedProcess(this.Platform, &quot;C:\any\path\to\workload.exe&quot;, arguments))
            {
                // Workload will be executed here. This ensures that profiling will run during period precisely when
                // the workload itself is running and can be stopped as soon as the workload exits. The exact behavior
                // depends upon how the background monitor running the profiler is implemented. However, these type of
                // background monitors are expected to be implemented following the recommendations above.
                 await process.StartAndWaitAsync(cancellationToken, timeout)
                     .ConfigureAwait(false);
            }
        }
    }
    catch (OperationCanceledException)
    {
        // Expected when a Task.Delay is cancelled.
    }
}

</code></pre></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/microsoft/VirtualClient/edit/main/website/docs/developing/0050-develop-profiling-monitor.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/VirtualClient/docs/developing/0040-vc-packages/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">VC Packages</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/VirtualClient/docs/developing/0060-workload-recommendations/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Workload Selection Recommendations</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#preliminaries" class="table-of-contents__link toc-highlight">Preliminaries</a></li><li><a href="#supported-profilers" class="table-of-contents__link toc-highlight">Supported Profilers</a></li><li><a href="#profiling-scenarios" class="table-of-contents__link toc-highlight">Profiling Scenarios</a></li><li><a href="#interval-based-profiling" class="table-of-contents__link toc-highlight">Interval-Based Profiling</a><ul><li><a href="#recommendations" class="table-of-contents__link toc-highlight">Recommendations:</a></li></ul></li><li><a href="#on-demand-profiling" class="table-of-contents__link toc-highlight">On-Demand Profiling</a><ul><li><a href="#recommendations-1" class="table-of-contents__link toc-highlight">Recommendations:</a></li></ul></li><li><a href="#bringing-it-all-together" class="table-of-contents__link toc-highlight">Bringing it All Together</a></li><li><a href="#profiling-integration-code-requirements" class="table-of-contents__link toc-highlight">Profiling Integration Code Requirements</a><ul><li><a href="#add-a-backgroundprofiling-block" class="table-of-contents__link toc-highlight">Add a BackgroundProfiling Block</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/VirtualClient/docs/overview/">Overview</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/microsoft/VirtualClient/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discussion<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/VirtualClient/blog/">Blog</a></li><li class="footer__item"><a href="https://github.com/microsoft/VirtualClient" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://microsoft.com/" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/VirtualClient/img/microsoft-logo-white-text.svg" alt="MSFT Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/VirtualClient/img/microsoft-logo-white-text.svg" alt="MSFT Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></a></div><div class="footer__copyright">Copyright © 2024 Microsoft.</div></div></div></footer></div>
</body>
</html>